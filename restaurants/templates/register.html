<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Restaurant exploration website">
    <link href="../static/landing.css" type="text/css" rel="stylesheet">
    <title>Restaurant Explorer</title>

    <style>
        /* General styles for the page */
        body, html {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
        }

        header {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 45px;
            position: relative; /* For positioning the login and search forms */
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
        }

        /* Style for the login form */
        #login-form {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        #login-form input[type="text"],
        #login-form input[type="password"] {
            padding: 5px;
            margin-bottom: 5px; /* Space between the input fields */
            font-size: 1em;
            width: 150px; /* Adjust width as needed */
        }

        #login-form button {
            padding: 5px 10px;
            background-color: gold;
            border: none;
            font-size: 1em;
            cursor: pointer;
            width: 160px; /* Match button width with input fields */
        }

        #login-form p {
            margin: 10px 0 0;
            font-size: 0.9em;
            color: #fff;
        }

        #login-form a {
            color: #007bff;
            text-decoration: none;
        }

        #login-form a:hover {
            text-decoration: underline;
        }

        /* Style for the search form and filters */
        #search-container {
            position: absolute;
            top: 20px;
            left: 20px;
        }

        #search-form {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        #search-form input[type="text"] {
            padding: 5px;
            font-size: 1em;
            width: 200px;
        }

        #search-form button {
            padding: 5px 10px;
            background-color: gold;
            border: none;
            font-size: 1em;
            cursor: pointer;
            margin-left: 5px;
        }

        #filter-options {
            display: flex;
            align-items: center;
        }

        #filter-options label {
            margin-right: 5px;
            color: white;
        }

        #filter-options select {
            margin-right: 10px;
            padding: 3px;
        }

        #map {
            height: 80vh;
            width: 100%;
        }

        #status {
            text-align: center;
            margin: 10px;
            font-size: 1.2em;
            color: #333;
        }

        footer {
            text-align: center;
            padding: 10px;
            background-color: #333;
            color: white;
        }
    </style>
</head>
<body>

    <!-- Header Section -->
    <header>
        <h1>Atlanta Food Finder</h1>
        <p>Discover new tastes or cozy up with an old favorite!</p>

        <!-- Login Form in the Top Right -->
        <form id="login-form" action="/login/" method="post">
            <input type="text" name="username" placeholder="Username" required>
            <input type="password" name="password" placeholder="Password" required>
            <button type="submit">Login</button>
            <a href="/register/">New User?</a><a href="/forgot-password/">Forgot Password?</a>
        </form>

        <!-- Restaurant Search Form and Filters in the Top Left -->
        <div id="search-container">
            <form id="search-form" onsubmit="searchRestaurants(event)">
                <input type="text" id="search-input" name="search_query" placeholder="Search Restaurants" required>
                <button type="submit">Search</button>
            </form>
            <div id="filter-options">
                <label for="rating-filter">Minimum Rating:</label>
                <select id="rating-filter">
                    <option value="0">Any</option>
                    <option value="3">3+ stars</option>
                    <option value="4">4+ stars</option>
                    <option value="4.5">4.5+ stars</option>
                </select>

                <label for="distance-filter">Maximum Distance:</label>
                <select id="distance-filter">
                    <option value="0">Any</option>
                    <option value="1000">1 km</option>
                    <option value="5000">5 km</option>
                    <option value="10000">10 km</option>
                    <option value="20000">20 km</option>
                </select>
            </div>
        </div>
    </header>

    <!-- Map Section -->
    <div id="map"></div>
    <div id="status">Finding nearby restaurants...</div>

    <!-- Footer Section -->
    <footer>
        <p>&copy; <a href="/about" style="color: deepskyblue; text-decoration: underline;">2340 Group 44</a>. All rights reserved.</p>
    </footer>

    <!-- Google Maps API and Places API Scripts -->
    <script>
        let map, infoWindow, service;
        let markers = [];
        let userLocation;

        function initMap() {
            // Create the map
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 33.7490, lng: -84.3880 }, // Default to Atlanta
                zoom: 14
            });

            // Create an InfoWindow to display details of the restaurants
            infoWindow = new google.maps.InfoWindow();

            // Create the PlacesService instance
            service = new google.maps.places.PlacesService(map);

            // Attempt to get the user's current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // Center the map on the user's location
                    map.setCenter(userLocation);

                    // Search for nearby restaurants
                    searchNearbyRestaurants(userLocation);

                }, function() {
                    handleLocationError(true, map.getCenter());
                });
            } else {
                // Browser doesn't support geolocation
                handleLocationError(false, map.getCenter());
            }
        }

        // Function to search for nearby restaurants using the Places API
        function searchNearbyRestaurants(location) {
            const request = {
                location: location,
                radius: '16000',  // Search radius in meters (16km)
                type: ['restaurant']  // Restaurant type
            };

            // Perform the nearby search
            service.nearbySearch(request, function(results, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    for (let i = 0; i < results.length; i++) {
                        createRestaurantMarker(results[i]);
                    }
                    document.getElementById('status').textContent = `Found ${results.length} restaurants nearby.`;
                } else {
                    document.getElementById('status').textContent = 'No restaurants found nearby.';
                }
            });
        }

        // Function to create markers for restaurants
        const cuisineTypes = [
            "Italian", "Chinese", "Japanese", "Thai", "Indian", "Mexican",
            "French", "Spanish", "Greek", "Turkish", "Vietnamese", "American", "Brazilian",
            "Peruvian", "Argentinian", "German", "Russian", "Lebanese", "Moroccan", "Ethiopian", "Vegan", "Seafood",
            "Steakhouse", "Barbecue", "Pizza", "Sushi", "Burger", "Salad", "Soup", "Noodle", "Curry", "Tapas",
            "Dessert", "Brewery", "Tea", "Breakfast"
        ];

        function createRestaurantMarker(place) {
            // Check if the place is actually a restaurant
            if (!place.types || !place.types.includes('restaurant')) {
                console.log('Skipping non-restaurant result:', place.name);
                return;  // Skip this result if it's not a restaurant
            }

            const marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location,
                title: place.name
            });

            markers.push(marker);

            service.getDetails({ placeId: place.place_id }, function(details, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    const photoUrl = details.photos ? details.photos[0].getUrl({ maxWidth: 200 }) : '';

                    // Convert rating to stars (out of 5)
                    const rating = details.rating || 0;
                    const fullStars = Math.floor(rating);
                    const halfStar = rating % 1 >= 0.5 ? '★' : '';
                    const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
                    const starRating = '★'.repeat(fullStars) + halfStar + '☆'.repeat(emptyStars);

                    // Determine cuisine type
                    let cuisine = determineCuisine(details);

                    // Calculate distance if user location is available
                    let distance = '';
                    if (userLocation) {
                        const distanceInMeters = google.maps.geometry.spherical.computeDistanceBetween(
                            new google.maps.LatLng(userLocation),
                            place.geometry.location
                        );
                        distance = `Distance: ${(distanceInMeters / 1000).toFixed(2)} km<br>`;
                    }

                    const contentString = `
                        <strong>${details.name}</strong><br>
                        Rating: ${starRating} (${rating})<br>
                        ${distance}
                        Address: ${details.formatted_address || 'N/A'}<br>
                        Phone: ${details.formatted_phone_number || 'N/A'}<br>
                        Cuisine: ${cuisine}<br>
                        ${photoUrl ? `<img src="${photoUrl}" alt="${details.name}" style="max-width:100%; height:auto;"><br>` : ''}
                        <a href="${details.url}" target="_blank">Google Reviews</a>
                    `;

                    // Add click listener to show restaurant info when marker is clicked
                    google.maps.event.addListener(marker, 'click', function() {
                        infoWindow.setContent(contentString);
                        infoWindow.open(map, this);
                    });
                }
            });
        }

        function determineCuisine(details) {
            // ... (keep existing determineCuisine function) ...
        }

        function determineGenericType(types) {
            // ... (keep existing determineGenericType function) ...
        }

        // Handle location errors
        function handleLocationError(browserHasGeolocation, pos) {
            document.getElementById('status').textContent = browserHasGeolocation
                ? 'Error: The geolocation service failed.'
                : 'Error: Your browser doesn\'t support geolocation.';
            map.setCenter(pos);
        }

        function searchRestaurants(event) {
            event.preventDefault();
            const query = document.getElementById('search-input').value;
            const ratingFilter = parseFloat(document.getElementById('rating-filter').value);
            const distanceFilter = parseInt(document.getElementById('distance-filter').value);

            const request = {
                query: query,
                type: ['restaurant'],
                fields: ['name', 'geometry', 'place_id', 'rating']
            };

            if (userLocation && distanceFilter > 0) {
                request.location = userLocation;
                request.radius = distanceFilter;
            }

            service.textSearch(request, function(results, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    clearMarkers();
                    let filteredResults = results.filter(place => place.rating >= ratingFilter);

                    for (let i = 0; i < filteredResults.length; i++) {
                        createRestaurantMarker(filteredResults[i]);
                    }

                    if (filteredResults.length > 0) {
                        map.setCenter(filteredResults[0].geometry.location);
                        map.setZoom(13);
                    }
                    document.getElementById('status').textContent = `Found ${filteredResults.length} restaurants matching "${query}"`;
                } else {
                    document.getElementById('status').textContent = 'No restaurants found matching your search.';
                }
            });
        }

        function clearMarkers() {
            for (let marker of markers) {
                marker.setMap(null);
            }
            markers = [];
        }
    </script>

    <!-- Load the Google Maps API and Places API -->
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLhkzfJDTflZZoU0SCz_lM6F7sm8vN3HM&libraries=places,geometry&callback=initMap">
    </script>

</body>
</html>