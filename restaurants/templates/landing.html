<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Restaurant exploration website">
    <link href="../static/landing.css" type = "text/css" rel="stylesheet">
    <title>Restaurant Explorer</title>
    
    <style>
        /* General styles for the page */
        body, html {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
        }

        header {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 20px;
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
        }

        #map {
            height: 80vh;
            width: 100%;
        }

        #status {
            text-align: center;
            margin: 10px;
            font-size: 1.2em;
            color: #333;
        }

        footer {
            text-align: center;
            padding: 10px;
            background-color: #333;
            color: white;
        }
    </style>
</head>
<body>

    <!-- Header Section -->
    <header>
        <h1>Atlanta Food Finder</h1>
        <p>Discover new tastes or cozy up with an old favorite!</p>
    </header>

    <!-- Map Section -->
    <div id="map"></div>
    <div id="status">Finding nearby restaurants...</div>

    <!-- Footer Section -->
    <footer>
        <p>&copy; 2340 Group 44. All rights reserved.</p>
    </footer>

    <!-- Google Maps API and Places API Scripts -->
    <script>
        let map, infoWindow, service;

        function initMap() {
            // Create the map
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: -33.8688, lng: 151.2195 }, // Default to Sydney
                zoom: 14
            });

            // Create an InfoWindow to display details of the restaurants
            infoWindow = new google.maps.InfoWindow();

            // Create the PlacesService instance
            service = new google.maps.places.PlacesService(map);

            // Attempt to get the user's current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // Center the map on the user's location
                    map.setCenter(userLocation);

                    // Search for nearby restaurants
                    searchNearbyRestaurants(userLocation);

                }, function() {
                    handleLocationError(true, map.getCenter());
                });
            } else {
                // Browser doesn't support geolocation
                handleLocationError(false, map.getCenter());
            }
        }

        // Function to search for nearby restaurants using the Places API
        function searchNearbyRestaurants(location) {
            const request = {
                location: location,
                radius: '1500',  // Search radius in meters (1.5km)
                type: ['restaurant']  // Restaurant type
            };

            // Perform the nearby search
            service.nearbySearch(request, function(results, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    for (let i = 0; i < results.length; i++) {
                        createRestaurantMarker(results[i]);
                    }
                    document.getElementById('status').textContent = `Found ${results.length} restaurants nearby.`;
                } else {
                    document.getElementById('status').textContent = 'No restaurants found nearby.';
                }
            });
        }

        // Function to create markers for restaurants
        const cuisineTypes = [
            "Italian", "Chinese", "Japanese", "Thai", "Indian", "Mexican", "Korean",
            "French", "Spanish", "Greek", "Turkish", "Vietnamese", "American", "Brazilian",
            "Peruvian", "Argentinian", "German", "Russian", "Lebanese", "Moroccan", "Ethiopian",
            "Vegetarian", "Vegan", "Seafood", "Steakhouse", "Barbecue", "Pizza", "Sushi",
            "Burger", "Sandwich", "Salad", "Soup", "Noodle", "Curry", "Tapas", "Dessert"
        ];

        function createRestaurantMarker(place) {
            const marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location,
                title: place.name
            });

            service.getDetails({ placeId: place.place_id }, function(details, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    const photoUrl = details.photos ? details.photos[0].getUrl({ maxWidth: 200 }) : '';

                    // Convert rating to stars (out of 5)
                    const rating = details.rating || 0;
                    const fullStars = Math.floor(rating);
                    const halfStar = rating % 1 >= 0.5 ? '★' : '';
                    const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
                    const starRating = '★'.repeat(fullStars) + halfStar + '☆'.repeat(emptyStars);

                    // Determine cuisine type
                    let cuisine = determineCuisine(details);

                    const contentString = `
                        <strong>${details.name}</strong><br>
                        Rating: ${starRating} (${rating})<br>
                        Address: ${details.formatted_address || 'N/A'}<br>
                        Phone: ${details.formatted_phone_number || 'N/A'}<br>
                        Cuisine: ${cuisine}<br>
                        ${photoUrl ? `<img src="${photoUrl}" alt="${details.name}" style="max-width:100%; height:auto;"><br>` : ''}
                        <a href="${details.url}" target="_blank">Google Reviews</a>
                    `;

                    // Add click listener to show restaurant info when marker is clicked
                    google.maps.event.addListener(marker, 'click', function() {
                        infoWindow.setContent(contentString);
                        infoWindow.open(map, this);
                    });
                }
            });
        }

        function determineCuisine(details) {
            // Check if there's a cuisine type in the types array
            for (let type of details.types) {
                const formattedType = type.replace(/_/g, ' ').toLowerCase();
                for (let cuisine of cuisineTypes) {
                    if (formattedType.includes(cuisine.toLowerCase())) {
                        return cuisine;
                    }
                }
            }

            // Check if there's a cuisine type in the name
            for (let cuisine of cuisineTypes) {
                if (details.name.toLowerCase().includes(cuisine.toLowerCase())) {
                    return cuisine;
                }
            }

            // Check if there's a cuisine type in the reviews
            if (details.reviews) {
                for (let review of details.reviews) {
                    for (let cuisine of cuisineTypes) {
                        if (review.text.toLowerCase().includes(cuisine.toLowerCase())) {
                            return cuisine;
                        }
                    }
                }
            }

            // If no specific cuisine is found, return a generic type
            return determineGenericType(details.types) || 'Restaurant';
        }

        function determineGenericType(types) {
            const genericTypes = {
                'cafe': 'Cafe',
                'bakery': 'Bakery',
                'bar': 'Bar',
                'night_club': 'Night Club',
                'food': 'Food',
                'restaurant': 'Restaurant'
            };

            for (let type of types) {
                if (genericTypes[type]) {
                    return genericTypes[type];
                }
            }

            return null;
        }

        // Handle location errors
        function handleLocationError(browserHasGeolocation, pos) {
            document.getElementById('status').textContent = browserHasGeolocation
                ? 'Error: The geolocation service failed.'
                : 'Error: Your browser doesn\'t support geolocation.';
            map.setCenter(pos);
        }
    </script>

    <!-- Load the Google Maps API and Places API -->
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLhkzfJDTflZZoU0SCz_lM6F7sm8vN3HM&libraries=places&callback=initMap">
    </script>

</body>
</html>
